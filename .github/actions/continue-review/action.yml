name: 'Continue Base Review'
description: 'Perform code review using Continue AI on pull requests'
author: 'Continue'

inputs:
  continue-api-key:
    description: 'API key for Continue service'
    required: true
  github-token:
    description: 'GitHub token for API access'
    required: true
  model:
    description: 'Model to use for code review'
    required: false
    default: 'claude-3-5-sonnet-20241022'
  provider:
    description: 'Provider for the model'
    required: false
    default: 'anthropic'
  api-base:
    description: 'API base URL for Continue service'
    required: false
    default: 'https://api.continue.dev'

runs:
  using: 'composite'
  steps:
    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install dependencies
      run: |
        pip install requests PyGithub
      shell: bash

    - name: Run Continue Review
      env:
        GITHUB_TOKEN: ${{ inputs.github-token }}
        CONTINUE_API_KEY: ${{ inputs.continue-api-key }}
        CONTINUE_MODEL: ${{ inputs.model }}
        CONTINUE_PROVIDER: ${{ inputs.provider }}
        CONTINUE_API_BASE: ${{ inputs.api-base }}
      run: |
        cat > /tmp/continue_review.py << 'EOF'
        import os
        import json
        import requests
        from github import Github
        import sys
        import traceback

        print("=== Continue Review Agent Starting ===")

        # Get environment variables
        github_token = os.environ.get('GITHUB_TOKEN')
        continue_api_key = os.environ.get('CONTINUE_API_KEY')
        model = os.environ.get('CONTINUE_MODEL', 'claude-3-5-sonnet-20241022')
        provider = os.environ.get('CONTINUE_PROVIDER', 'anthropic')
        api_base = os.environ.get('CONTINUE_API_BASE', 'https://api.continue.dev')

        print(f"Model: {model}")
        print(f"Provider: {provider}")
        print(f"API Base: {api_base}")
        print(f"API Key present: {bool(continue_api_key)}")

        # Get GitHub context
        github_context = json.loads(os.environ.get('GITHUB_CONTEXT', '{}'))
        repo_name = github_context.get('repository', '')
        
        print(f"Repository: {repo_name}")
        
        # Handle different event types
        event_name = github_context.get('event_name', '')
        print(f"Event type: {event_name}")
        
        pr_number = None
        if event_name == 'pull_request':
            pr_number = github_context.get('event', {}).get('pull_request', {}).get('number')
        elif event_name == 'issue_comment':
            pr_number = github_context.get('event', {}).get('issue', {}).get('number')
        elif event_name == 'workflow_dispatch':
            # For manual runs, try to get PR from the context
            pr_number = github_context.get('event', {}).get('inputs', {}).get('pr_number')
            if not pr_number:
                print("Workflow dispatch without PR number, exiting")
                sys.exit(0)
        else:
            print(f"Unsupported event type: {event_name}")
            sys.exit(0)

        if not pr_number:
            print("No PR number found")
            print(f"Event data: {json.dumps(github_context.get('event', {}), indent=2)}")
            sys.exit(0)

        print(f"PR Number: {pr_number}")

        try:
            # Initialize GitHub client
            g = Github(github_token)
            repo = g.get_repo(repo_name)
            pr = repo.get_pull(pr_number)
            
            print(f"PR Title: {pr.title}")
            print(f"PR State: {pr.state}")

            # Get PR diff
            files = pr.get_files()
            
            diff_content = []
            file_count = 0
            for file in files:
                file_count += 1
                if file.patch:
                    diff_content.append(f"File: {file.filename}\n{file.patch}")
            
            print(f"Files changed: {file_count}")
            
            if not diff_content:
                print("No changes to review")
                sys.exit(0)

            full_diff = "\n\n".join(diff_content)
            diff_size = len(full_diff)
            print(f"Diff size: {diff_size} characters")

            # Truncate diff if too large
            max_diff_size = 8000
            if diff_size > max_diff_size:
                full_diff = full_diff[:max_diff_size] + "\n\n... (diff truncated)"
                print(f"Diff truncated to {max_diff_size} characters")

            # Check if Continue API key is available
            if not continue_api_key:
                print("No Continue API key found, posting test comment")
                comment_body = "## ü§ñ Continue AI Review\n\n"
                comment_body += "‚ö†Ô∏è **Test Mode**: Continue API key not configured.\n\n"
                comment_body += "**PR Summary:**\n"
                comment_body += f"- Title: {pr.title}\n"
                comment_body += f"- Files changed: {file_count}\n"
                comment_body += f"- Diff size: {diff_size} characters\n\n"
                comment_body += "To enable AI reviews, set the `CONTINUE_API_KEY` secret in repository settings.\n\n"
                comment_body += "---\n"
                comment_body += "*Powered by [Continue](https://continue.dev)*"
            else:
                print("Continue API key found, generating AI review...")
                
                # Prepare the prompt for the AI
                prompt = f"Review this pull request and provide constructive feedback:\n\n"
                prompt += f"PR Title: {pr.title}\n"
                prompt += f"Files changed: {file_count}\n\n"
                prompt += f"Changes:\n{full_diff}"
                
                # Call Continue API or use a standard AI API
                # For now, we'll use a simple format that could work with various APIs
                review_request = {
                    "model": model,
                    "messages": [
                        {
                            "role": "system",
                            "content": "You are a helpful code reviewer. Review the pull request changes and provide constructive feedback. Focus on: 1) Code quality and best practices, 2) Potential bugs or issues, 3) Security concerns, 4) Performance implications, 5) Suggestions for improvement."
                        },
                        {
                            "role": "user",
                            "content": prompt
                        }
                    ],
                    "temperature": 0.3,
                    "max_tokens": 2000
                }
                
                # Try different API endpoints based on provider
                api_url = api_base
                if provider == "anthropic":
                    api_url = "https://api.anthropic.com/v1/messages"
                    headers = {
                        "x-api-key": continue_api_key,
                        "anthropic-version": "2023-06-01",
                        "content-type": "application/json"
                    }
                elif provider == "openai":
                    api_url = "https://api.openai.com/v1/chat/completions"
                    headers = {
                        "Authorization": f"Bearer {continue_api_key}",
                        "Content-Type": "application/json"
                    }
                else:
                    # Default Continue API
                    api_url = f"{api_base}/v1/chat/completions"
                    headers = {
                        "Authorization": f"Bearer {continue_api_key}",
                        "Content-Type": "application/json"
                    }
                
                print(f"Calling API: {api_url}")
                
                try:
                    response = requests.post(api_url, json=review_request, headers=headers, timeout=30)
                    print(f"API Response Status: {response.status_code}")
                    
                    if response.status_code == 200:
                        result = response.json()
                        
                        # Extract review text based on provider format
                        if provider == "anthropic":
                            review_text = result.get("content", [{}])[0].get("text", "No review generated")
                        else:
                            # OpenAI/Continue format
                            review_text = result.get("choices", [{}])[0].get("message", {}).get("content", "No review generated")
                        
                        comment_body = "## ü§ñ Continue AI Review\n\n"
                        comment_body += review_text
                        comment_body += "\n\n---\n"
                        comment_body += "*Powered by [Continue](https://continue.dev)*"
                    else:
                        print(f"API Error: {response.text}")
                        comment_body = "## ü§ñ Continue AI Review\n\n"
                        comment_body += f"‚ö†Ô∏è Failed to generate AI review (API returned {response.status_code})\n\n"
                        comment_body += "**PR Summary:**\n"
                        comment_body += f"- Title: {pr.title}\n"
                        comment_body += f"- Files changed: {file_count}\n"
                        comment_body += f"- Diff size: {diff_size} characters\n\n"
                        comment_body += "Please check the Continue API configuration.\n\n"
                        comment_body += "---\n"
                        comment_body += "*Powered by [Continue](https://continue.dev)*"
                        
                except requests.exceptions.RequestException as req_err:
                    print(f"Request failed: {str(req_err)}")
                    comment_body = "## ü§ñ Continue AI Review\n\n"
                    comment_body += f"‚ö†Ô∏è Failed to connect to API: {str(req_err)}\n\n"
                    comment_body += "**PR Summary:**\n"
                    comment_body += f"- Title: {pr.title}\n"
                    comment_body += f"- Files changed: {file_count}\n"
                    comment_body += f"- Diff size: {diff_size} characters\n\n"
                    comment_body += "---\n"
                    comment_body += "*Powered by [Continue](https://continue.dev)*"

            # Post comment
            print("Posting review comment...")
            comment = pr.create_issue_comment(comment_body)
            print(f"Comment posted successfully! ID: {comment.id}")
            
        except Exception as e:
            print(f"Error during review: {str(e)}")
            print(f"Traceback: {traceback.format_exc()}")
            
            # Try to post error as comment
            try:
                error_comment = "## ‚ùå Continue Review Error\n\n"
                error_comment += "Failed to complete review due to an error:\n"
                error_comment += f"```\n{str(e)}\n```\n\n"
                error_comment += "Please check the workflow logs for more details."
                pr.create_issue_comment(error_comment)
                print("Error comment posted")
            except Exception as e2:
                print(f"Failed to post error comment: {str(e2)}")
            
            sys.exit(1)

        print("=== Continue Review Agent Completed ===")
        EOF

        # Set GitHub context
        export GITHUB_CONTEXT='${{ toJson(github) }}'
        
        # Run the review script
        python /tmp/continue_review.py
      shell: bash

branding:
  icon: 'code'
  color: 'blue'