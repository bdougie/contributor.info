name: Security Scanning with Snyk MCP

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]
  schedule:
    - cron: '0 8 * * *' # Daily at 8 AM UTC

jobs:
  security-scan:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install Continue CLI
        run: |
          npm install -g @continuedev/cli
          echo "‚úÖ Continue CLI installed"

      - name: Validate Secrets
        run: |
          if [ -z "${{ secrets.CONTINUE_API_KEY }}" ]; then
            echo "‚ùå Error: CONTINUE_API_KEY secret is not set"
            exit 1
          fi
          if [ -z "${{ secrets.SNYK_TOKEN }}" ]; then
            echo "‚ùå Error: SNYK_TOKEN secret is not set"
            exit 1
          fi
          echo "‚úÖ Required secrets are configured"

      - name: Run Security Scans
        env:
          CONTINUE_API_KEY: ${{ secrets.CONTINUE_API_KEY }}
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        run: |
          set -e  # Exit on any error

          echo "üîç Running code vulnerability scan..."
          if ! cn -p "Run Snyk Code scan with severity high on this repo. Fail if any high issues are present. Note: Snyk CLI is already authenticated via SNYK_TOKEN environment variable." --auto; then
            echo "‚ùå Error: Snyk Code scan failed or found high severity issues"
            exit 1
          fi
          echo "‚úÖ Code vulnerability scan completed"

          echo "üì¶ Checking dependencies..."
          if ! cn -p "Run Snyk Open Source on this repo. Fail on fixable high issues. Note: Snyk CLI is already authenticated via SNYK_TOKEN environment variable." --auto; then
            echo "‚ùå Error: Snyk Open Source scan failed or found fixable high severity issues"
            exit 1
          fi
          echo "‚úÖ Dependency scan completed"

      - name: Generate Security Report
        if: always()
        continue-on-error: true
        env:
          CONTINUE_API_KEY: ${{ secrets.CONTINUE_API_KEY }}
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        run: |
          echo "üìä Generating security report..."
          cn -p "Generate a markdown security report summarizing total vulnerabilities by severity, top 3 critical issues if any, and recommended next steps. Save the report to scan-results.md file." --auto || {
            echo "‚ö†Ô∏è Warning: Could not generate security report via Continue CLI"
            echo "Manual review of security scan results recommended"
            exit 0
          }

          if [ -f scan-results.md ]; then
            echo "‚úÖ Security report generated successfully"
          else
            echo "‚ö†Ô∏è Warning: scan-results.md was not created"
          fi

      - name: Upload Security Report
        if: always()
        continue-on-error: true
        uses: actions/upload-artifact@v4
        with:
          name: security-scan-results
          path: scan-results.md
          if-no-files-found: warn
