name: Continue Code Review

on:
  pull_request:
    types: [opened, synchronize, ready_for_review]
  issue_comment:
    types: [created]

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  review:
    runs-on: ubuntu-latest
    # Only run on PRs or when @review-bot is mentioned
    if: |
      github.event_name == 'pull_request' ||
      (github.event_name == 'issue_comment' && contains(github.event.comment.body, '@review-bot'))

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Full history for better context

      # Optional: Use GitHub App token for better rate limits
      - name: Generate App Token
        id: app-token
        if: vars.APP_ID != ''
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ vars.APP_ID }}
          private-key: ${{ secrets.APP_PRIVATE_KEY }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Continue CLI
        run: npm i -g @continuedev/cli

      - name: Get Pull Request Details
        id: pr
        env:
          GH_TOKEN: ${{ steps.app-token.outputs.token || github.token }}
        run: |
          # Get pull request number and details
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            PR_NUMBER=${{ github.event.pull_request.number }}
          else
            PR_NUMBER=$(jq -r .issue.number "$GITHUB_EVENT_PATH")
          fi

          echo "pr_number=$PR_NUMBER" >> $GITHUB_OUTPUT

          # Get pull request diff
          gh pr diff $PR_NUMBER > pr.diff

          # Get changed files
          gh pr view $PR_NUMBER --json files -q '.files[].path' > changed_files.txt

      - name: Run Continue Review
        env:
          CONTINUE_API_KEY: ${{ secrets.CONTINUE_API_KEY }}
          GH_TOKEN: ${{ steps.app-token.outputs.token || github.token }}
        run: |
          # Validate API key is set
          if [ -z "$CONTINUE_API_KEY" ]; then
            echo "âŒ Error: CONTINUE_API_KEY secret is not set"
            echo "Please add your API key from https://hub.continue.dev/settings/api-keys"
            exit 1
          fi

          # Check if custom rules exist and build rules context
          if [ -d ".continue/rules" ]; then
            echo "ðŸ“‹ Found custom rules in .continue/rules/"
            ls -la .continue/rules/
            echo "## Custom Project Rules" > rules_context.md
            cat .continue/rules/*.md >> rules_context.md
          else
            echo "â„¹ï¸  No custom rules found. Using general best practices."
            echo "Review for general best practices, security issues, and code quality." > rules_context.md
          fi

          # Build review prompt file
          echo "Review this pull request with the following context:" > review_prompt.txt
          echo "" >> review_prompt.txt
          echo "## Changed Files" >> review_prompt.txt
          cat changed_files.txt >> review_prompt.txt
          echo "" >> review_prompt.txt
          echo "## Diff" >> review_prompt.txt
          echo '```diff' >> review_prompt.txt
          cat pr.diff >> review_prompt.txt
          echo '```' >> review_prompt.txt
          echo "" >> review_prompt.txt
          echo "## Instructions" >> review_prompt.txt
          cat rules_context.md >> review_prompt.txt
          echo "" >> review_prompt.txt
          echo "Provide:" >> review_prompt.txt
          echo "1. A brief summary of changes" >> review_prompt.txt
          echo "2. Key findings (potential issues, security concerns, suggestions)" >> review_prompt.txt
          echo "3. Positive observations (good practices, improvements)" >> review_prompt.txt
          echo "4. Specific actionable recommendations" >> review_prompt.txt
          echo "" >> review_prompt.txt
          echo "Format as markdown suitable for a GitHub pull request comment." >> review_prompt.txt

          # Run Continue CLI in headless mode with verbose logging
          # Note: Not using --config flag as continuedev/code-reviewer doesn't exist
          # Continue CLI will use default configuration
          echo "ðŸ¤– Running Continue CLI review..."
          if cn --verbose < review_prompt.txt > review_output.md 2>&1; then
            echo "âœ… Review completed successfully"
          else
            EXIT_CODE=$?
            echo "âŒ Continue CLI failed with exit code $EXIT_CODE"
            echo "Output:"
            cat review_output.md || echo "No output file generated"
            echo ""
            echo "Check logs at ~/.continue/logs/cn.log for more details"
            exit 1
          fi

      - name: Post Review Comment
        env:
          GH_TOKEN: ${{ steps.app-token.outputs.token || github.token }}
        run: |
          # Add header
          cat > review_comment.md <<'EOF'
          ## ðŸ¤– AI Code Review

          EOF

          # Add review content
          cat review_output.md >> review_comment.md

          # Add footer
          cat >> review_comment.md <<'EOF'

          ---
          *Powered by [Continue](https://continue.dev) â€¢ Need a focused review? Comment `@review-bot check for [specific concern]`*
          EOF

          # Check for existing review comment
          EXISTING_COMMENT=$(gh pr view ${{ steps.pr.outputs.pr_number }} \
            --json comments -q '.comments[] | select(.body | contains("ðŸ¤– AI Code Review")) | .id' | head -1)

          if [ -n "$EXISTING_COMMENT" ]; then
            echo "Updating existing comment..."
            gh api --method PATCH \
              "repos/${{ github.repository }}/issues/comments/$EXISTING_COMMENT" \
              -f body="$(cat review_comment.md)"
          else
            echo "Creating new comment..."
            gh pr comment ${{ steps.pr.outputs.pr_number }} \
              --body-file review_comment.md
          fi
