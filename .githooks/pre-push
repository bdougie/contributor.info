#!/bin/sh

# Pre-push hook that runs checks before pushing
# This ensures code compiles and passes basic quality checks before pushing

echo "🔨 Running pre-push checks..."

# Run TypeScript compilation check
echo "📝 Checking TypeScript compilation..."
tsc --noEmit
BUILD_STATUS=$?

# Check if build failed
if [ $BUILD_STATUS -ne 0 ]; then
    echo "❌ TypeScript compilation failed! Please fix errors before pushing."
    echo "💡 Run 'tsc --noEmit' to see the errors."
    exit 1
fi

echo "✅ TypeScript compilation successful!"

# Lint only staged files for better performance
echo "🧹 Linting staged files..."
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(ts|tsx)$')

if [ -n "$STAGED_FILES" ]; then
    echo "Linting files: $STAGED_FILES"
    npx eslint $STAGED_FILES --max-warnings 5
    LINT_STATUS=$?
    
    if [ $LINT_STATUS -ne 0 ]; then
        echo "❌ Linting failed! Please fix errors before pushing."
        echo "💡 Run 'npm run lint' to see all issues."
        exit 1
    fi
    echo "✅ Linting passed!"
else
    echo "ℹ️ No TypeScript files to lint."
fi

echo "✅ All pre-push checks passed! Proceeding with push..."

exit 0