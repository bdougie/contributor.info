# GitHub Issue: Workspace Repository Backfill for Extended Data Retention Addon

**Title:** Implement automatic full data backfill for workspace repositories when Extended Data Retention addon is purchased

**Labels:** feature, workspace, subscription, backfill, data-retention, addon

---

### Problem Statement

When users purchase the **Extended Data Retention** addon for their workspace subscription, we need to automatically trigger a comprehensive backfill of ALL historical data for ALL repositories in their workspace(s), up to the purchased retention period.

Currently:
- The WorkspaceBackfillManager only handles 90 days of GitHub event data (stars, forks, activity)
- Backfill is manual and repository-by-repository
- Extended data retention addon exists but doesn't trigger automatic historical data collection

### Current Implementation

**Existing Systems:**
- `src/components/features/workspace/WorkspaceBackfillManager.tsx` - Manual 90-day event backfill
- `supabase/functions/github-backfill/index.ts` - Event backfill edge function
- `src/services/polar/subscription.service.ts` - Subscription tier management with addons
- `src/lib/subscription-limits.ts` - Feature limits and checks

**Addon Configuration** (from subscription.service.ts:62-65):
```typescript
addons: {
  additionalWorkspace: 12,
  extendedDataRetention: 10, // TBD pricing
}
```

### Proposed Solution

#### Phase 1: Addon Purchase Detection & Trigger System

1. **Webhook Handler for Addon Purchase**
   - Create new edge function: `supabase/functions/addon-purchased/index.ts`
   - Listen for Polar webhook events when addon is purchased
   - Trigger workspace backfill workflow

2. **Database Schema Updates**
   - Add `workspace_backfill_jobs` table to track backfill progress:
     ```sql
     CREATE TABLE workspace_backfill_jobs (
       id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
       workspace_id UUID NOT NULL REFERENCES workspaces(id),
       addon_type TEXT NOT NULL,
       retention_days INTEGER NOT NULL,
       status TEXT NOT NULL CHECK (status IN ('pending', 'in_progress', 'completed', 'failed')),
       total_repositories INTEGER,
       completed_repositories INTEGER DEFAULT 0,
       started_at TIMESTAMPTZ,
       completed_at TIMESTAMPTZ,
       error_message TEXT,
       metadata JSONB DEFAULT '{}'::jsonb
     );
     ```

3. **Backfill Service**
   - Create `src/services/workspace-backfill.service.ts`:
     - `triggerWorkspaceBackfill(workspaceId, retentionDays)`
     - `processRepositoryBackfill(repositoryId, retentionDays)`
     - Track overall progress and update job status

#### Phase 2: Comprehensive Data Backfill

Extend backfill to cover ALL data types, not just events:

1. **Pull Requests** (files: src/lib/progressive-capture/historical-pr-sync.js)
   - Historical PRs with full details
   - PR reviews and comments
   - PR reviewers data
   - PR labels, milestones, and metadata

2. **Issues** (files: src/lib/sync-workspace-issues.ts)
   - Historical issues with full details
   - Issue comments
   - Issue events (labeled, assigned, closed, etc.)
   - Linked PRs

3. **Discussions** (files: src/lib/sync-discussions.ts)
   - Historical discussions
   - Discussion comments
   - Discussion categories

4. **GitHub Events** (files: supabase/functions/github-backfill/)
   - WatchEvents (stars)
   - ForkEvents
   - PushEvents
   - ReleaseEvents
   - All other relevant event types

5. **AI Embeddings** (files: src/lib/inngest/functions/compute-embeddings.ts)
   - Generate embeddings for all historical PRs
   - Generate embeddings for all historical issues
   - Generate embeddings for all historical discussions

#### Phase 3: Progress Tracking & UI

1. **Real-time Progress Monitoring**
   - Create `src/components/features/workspace/WorkspaceBackfillProgress.tsx`
   - Show progress per repository
   - Show overall workspace backfill progress
   - Estimated time remaining
   - Data breakdown (PRs processed, issues processed, etc.)

2. **Settings Integration**
   - Add backfill status to workspace settings
   - Show addon details (retention period, purchase date)
   - Option to retry failed backfills
   - Option to manually trigger additional backfills

3. **Notifications**
   - Toast notification when backfill starts
   - In-app notification when backfill completes
   - Email notification for completion (optional)
   - Error notifications if backfill fails

#### Phase 4: Performance & Reliability

1. **Queue Management**
   - Use existing `src/lib/progressive-capture/hybrid-queue-manager.ts`
   - Route historical data to GitHub Actions for bulk processing
   - Route recent data to Inngest for real-time processing
   - Implement rate limiting to avoid GitHub API throttling

2. **Error Handling**
   - Retry logic for failed repository backfills
   - Graceful degradation if some repositories fail
   - Detailed error logging in `workspace_backfill_jobs.metadata`

3. **Cost Optimization**
   - Batch process repositories to minimize edge function invocations
   - Use GraphQL for large repositories
   - Cache intermediate results
   - Respect GitHub API rate limits

### Acceptance Criteria

- [ ] When user purchases Extended Data Retention addon, backfill automatically triggers
- [ ] All repositories in workspace are backfilled up to purchased retention period
- [ ] Backfill includes: PRs, issues, discussions, comments, events, embeddings
- [ ] Progress is tracked in real-time and visible in workspace settings
- [ ] Users receive notifications when backfill starts and completes
- [ ] Failed backfills can be retried manually
- [ ] Backfill respects GitHub API rate limits and uses cost-effective routing
- [ ] Database tracks all backfill jobs with detailed status and metadata
- [ ] Existing WorkspaceBackfillManager is updated or replaced to use new system

### Technical Considerations

**Files to Create:**
- `supabase/functions/addon-purchased/index.ts`
- `supabase/migrations/YYYYMMDD_workspace_backfill_jobs.sql`
- `src/services/workspace-backfill.service.ts`
- `src/components/features/workspace/WorkspaceBackfillProgress.tsx`
- `src/hooks/use-workspace-backfill-status.ts`

**Files to Modify:**
- `src/components/features/workspace/WorkspaceBackfillManager.tsx` - Integrate with new service
- `src/components/features/workspace/settings/WorkspaceSettings.tsx` - Add backfill progress UI
- `src/services/polar/subscription.service.ts` - Add addon purchase tracking
- `src/lib/progressive-capture/hybrid-queue-manager.ts` - Support workspace-level backfills

**Dependencies:**
- Polar webhooks configuration
- GitHub API token with sufficient permissions
- Inngest configuration for background jobs
- GitHub Actions for bulk historical processing

### Related Files

- WorkspaceBackfillManager.tsx:303 - Current 90-day event backfill implementation
- subscription.service.ts:62-65 - Extended data retention addon definition
- github-backfill/index.ts - Event backfill edge function
- PRD: tasks/prd-activity-feed-improvements.md - Historical data usage examples

### Priority

**HIGH** - This is a premium feature that directly impacts revenue and user value proposition for paid plans.

---

## To Create This Issue

Run the following command from your terminal:

```bash
gh issue create \
  --title "Implement automatic full data backfill for workspace repositories when Extended Data Retention addon is purchased" \
  --body-file .github-issue-workspace-backfill.md \
  --label "feature,workspace,subscription,backfill,data-retention,addon"
```

Or visit: https://github.com/bdougie/contributor.info/issues/new
